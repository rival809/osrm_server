<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSRM Tile Service - Jawa Barat</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        #header p {
            font-size: 14px;
            opacity: 0.9;
        }
        #controls {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .input-group label {
            font-size: 14px;
            font-weight: 600;
            min-width: 50px;
        }
        .input-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 150px;
        }
        button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }
        button:hover {
            background: #5568d3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #map {
            flex: 1;
            position: relative;
        }
        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        #info.show {
            display: block;
        }
        #info h3 {
            margin-bottom: 10px;
            color: #667eea;
        }
        #info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .marker-start {
            background-color: #22c55e;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .marker-end {
            background-color: #ef4444;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üó∫Ô∏è OSRM Tile Service - Jawa Barat</h1>
        <p>Routing dan Tile Server untuk Wilayah Jawa Barat</p>
    </div>
    
    <div id="controls">
        <div class="input-group">
            <label>Start:</label>
            <input type="text" id="start" placeholder="lon,lat" value="107.6191,-6.9175">
        </div>
        <div class="input-group">
            <label>End:</label>
            <input type="text" id="end" placeholder="lon,lat" value="107.6098,-6.9145">
        </div>
        <button id="routeBtn">üõ£Ô∏è Cari Rute</button>
        <button id="clearBtn">üóëÔ∏è Clear</button>
    </div>

    <div id="map"></div>
    
    <div id="info">
        <h3>üìä Informasi Rute</h3>
        <p><strong>Jarak:</strong> <span id="distance">-</span></p>
        <p><strong>Durasi:</strong> <span id="duration">-</span></p>
        <p><strong>Status:</strong> <span id="status">-</span></p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Use relative URL to go through Nginx
        const API_URL = window.location.origin;
        
        // Initialize map - center on Bandung
        const map = L.map('map').setView([-6.9175, 107.6191], 13);
        
        // Use OSM tiles directly for now (local tiles have issues)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 8,
            subdomains: ['a', 'b', 'c']
        }).addTo(map);
        
        console.log('Map initialized with OSM tiles');

        let startMarker = null;
        let endMarker = null;
        let routeLine = null;

        // Elements
        const startInput = document.getElementById('start');
        const endInput = document.getElementById('end');
        const routeBtn = document.getElementById('routeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const info = document.getElementById('info');
        const distanceEl = document.getElementById('distance');
        const durationEl = document.getElementById('duration');
        const statusEl = document.getElementById('status');

        // Parse coordinate string
        function parseCoord(coordStr) {
            const [lon, lat] = coordStr.split(',').map(s => parseFloat(s.trim()));
            return { lon, lat };
        }

        // Format distance
        function formatDistance(meters) {
            if (meters < 1000) {
                return `${Math.round(meters)} m`;
            }
            return `${(meters / 1000).toFixed(2)} km`;
        }

        // Format duration
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}j ${minutes}m ${secs}d`;
            }
            if (minutes > 0) {
                return `${minutes}m ${secs}d`;
            }
            return `${secs}d`;
        }

        // Get route
        async function getRoute() {
            try {
                routeBtn.disabled = true;
                statusEl.textContent = 'Mencari rute...';
                info.classList.add('show');

                const start = parseCoord(startInput.value);
                const end = parseCoord(endInput.value);

                // Add markers
                if (startMarker) map.removeLayer(startMarker);
                if (endMarker) map.removeLayer(endMarker);

                startMarker = L.circleMarker([start.lat, start.lon], {
                    radius: 8,
                    fillColor: '#22c55e',
                    color: 'white',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(map);

                endMarker = L.circleMarker([end.lat, end.lon], {
                    radius: 8,
                    fillColor: '#ef4444',
                    color: 'white',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(map);

                // Request route
                const response = await fetch(
                    `${API_URL}/route?start=${start.lon},${start.lat}&end=${end.lon},${end.lat}`
                );
                const data = await response.json();

                if (!data.success || !data.data.routes || data.data.routes.length === 0) {
                    throw new Error('Rute tidak ditemukan');
                }

                const route = data.data.routes[0];

                // Draw route
                if (routeLine) map.removeLayer(routeLine);
                
                const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                routeLine = L.polyline(coordinates, {
                    color: '#667eea',
                    weight: 5,
                    opacity: 0.7
                }).addTo(map);

                // Fit bounds
                const bounds = L.latLngBounds(coordinates);
                map.fitBounds(bounds, { padding: [50, 50] });

                // Update info
                distanceEl.textContent = formatDistance(route.distance);
                durationEl.textContent = formatDuration(route.duration);
                statusEl.textContent = '‚úÖ Berhasil';

            } catch (error) {
                console.error('Error:', error);
                statusEl.textContent = `‚ùå Error: ${error.message}`;
                distanceEl.textContent = '-';
                durationEl.textContent = '-';
            } finally {
                routeBtn.disabled = false;
            }
        }

        // Clear map
        function clearMap() {
            if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
            }
            if (endMarker) {
                map.removeLayer(endMarker);
                endMarker = null;
            }
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
            info.classList.remove('show');
            distanceEl.textContent = '-';
            durationEl.textContent = '-';
            statusEl.textContent = '-';
        }

        // Click map to set coordinates
        let clickMode = 'start';
        map.on('click', (e) => {
            const coord = `${e.latlng.lng.toFixed(6)},${e.latlng.lat.toFixed(6)}`;
            
            if (clickMode === 'start') {
                startInput.value = coord;
                clickMode = 'end';
            } else {
                endInput.value = coord;
                clickMode = 'start';
            }
        });

        // Event listeners
        routeBtn.addEventListener('click', getRoute);
        clearBtn.addEventListener('click', clearMap);

        // Enter key to search
        [startInput, endInput].forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') getRoute();
            });
        });

        console.log('üó∫Ô∏è OSRM Tile Service Demo');
        console.log('Click on map to set start/end points');
    </script>
</body>
</html>
