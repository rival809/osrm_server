version: "3.8"

# Production Override Configuration
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# IMPORTANT: Adjust CPU limits based on your server:
# - For 2 vCPU servers: Total CPU allocation = 2.0 (Backend 1.0 + API1 0.5 + API2 0.5)
# - For 4+ vCPU servers: Increase accordingly
#
# Memory: Optimized for 8GB+ RAM servers
# Total memory allocation: ~8.5GB (Backend 4G + API1 2G + API2 2G + Nginx 512M)

services:
  nginx:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.25"

  osrm-backend:
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "1.0"
        reservations:
          memory: 2G
          cpus: "0.5"

  osrm-api-1:
    environment:
      - MAX_CACHE_SIZE_MB=1000
      - PRELOAD_ENABLED=false # Keep false for faster startup
      - NODE_OPTIONS=--max-old-space-size=1536
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "0.5"

  osrm-api-2:
    environment:
      - MAX_CACHE_SIZE_MB=1000
      - PRELOAD_ENABLED=false # Keep false for faster startup
      - NODE_OPTIONS=--max-old-space-size=1536
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "0.5"
